# include "../open/jorinde.h"
# include "../include/index.h"

# define SECURE() (previous_program() == INDEXD || previous_program() == INDEX_OBJECT)

mapping index;
mapping pointers;

static void create(varargs int clone)
{
	index = ([ ]);
	pointers = ([ ]);
}

int add_pointer(int fileid, int *indices)
{
	if(pointers[fileid]) {
		pointers[fileid] |= indices;
	} else {
		pointers[fileid] = indices;
	}

	return TRUE;
}
                                                                                
int *get_pointers()
{
	if(!SECURE()) {
		error("illegal call");
	}
	
	return map_indices(pointers);
}


/* returns 1 if a new word was added, 0 otherwise */
int add_word(string word, int fileid, int *indices)
{
	int wlen, ret;
	
	if(!SECURE()) {
		error("illegal call");
	}

	if(!index[word[0..0]]) {
		index[word[0..0]] = clone_object( INDEX_OBJECT );
	}

	wlen = strlen(word);

	if(wlen > 1) {
		ret = index[word[0..0]]->add_word( word[1..], fileid, indices );
	} else {
		if(!map_sizeof(pointers)) {
			/* This is a new word, then */
			ret = 1;
		}
		add_pointer( fileid, indices );
	}

	return ret;
}


int *get_hits(string word)
{
	if(!SECURE()) {
		error("illegal call");
	}
	
	if(strlen(word) > 1) {
		if(index[word[0..0]]) {
			return index[word[0..0]]->get_hits( word[1..] );
		} else {
			return ({ });
		}
	} else {
		return get_pointers();
	}
}

